<script lang="ts" setup>
import {computed, onMounted, onUnmounted, ref} from "vue"
import {Project} from "../interfaces/configs.ts"
import {homeDir} from "@tauri-apps/api/path"
import {invoke} from "@tauri-apps/api/tauri"
import {open as pickFolder} from "@tauri-apps/api/dialog"
import {writeText} from "@tauri-apps/api/clipboard"
import {emit} from "@tauri-apps/api/event"
import {SEND_NOTIFICATION} from "../utils/data/events-names.ts"
import {AddNotification} from "../interfaces/notifications.ts"
import BaseButton from "../components/buttons/BaseButton.vue"
import CustomScrollbar from "../components/CustomScrollbar.vue"
import {contextMenuItems} from "../utils/data/context-menu-items.ts"
import {ContextMenuItem} from "../interfaces/context-menu.ts"
import ContextMenu from "../components/ContextMenu.vue"
import RecentProjectListItem from "../components/lists/RecentProjectListItem.vue"
import {ProjectData, ProjectInfo} from "../interfaces/projects.ts"
import BaseModal from "../components/BaseModal.vue"
import SingleLineInput from "../components/inputs/SingleLineInput.vue";
import LineSeparator from "../components/LineSeparator.vue";
import PathSelectInput from "../components/inputs/PathSelectInput.vue";

const projects = ref<Project[]>([])
const sortedProjects = computed(() => projects.value.sort((a, b) =>
    new Date(b.last_opened).getTime() - new Date(a.last_opened).getTime()
))

const homePath = ref<string>("null")
const contextMenu = ref<{
    x: number
    y: number
    items: ContextMenuItem[]
    context: Project
} | null>(null)

const modalInitProject = ref<{ path: string, projectInfo: ProjectInfo } | null>(null)

const refreshProjects = async () => {
    try {
        projects.value = await invoke<Project[]>('get_recent_projects')
    } catch (error) {
        console.error(error)
    }
}

onMounted(async () => {
    homePath.value = await homeDir()
    await refreshProjects()

    window.addEventListener('focus', refreshProjects)
})
onUnmounted(() => {
    window.removeEventListener('focus', refreshProjects)
})

const execAction = async (action: string) => {
    if (contextMenu.value?.context) {
        switch (action) {
            case "copyPath":
                await writeText(contextMenu.value?.context.path)
                emit(SEND_NOTIFICATION, {
                    message: "Le chemin a bien été copié",
                    type: "info"
                } as AddNotification)
                break
            case "removeFromList":
                projects.value = await invoke<Project[]>('remove_project', {path: contextMenu.value?.context.path})
                emit(SEND_NOTIFICATION, {
                    message: "Le projet a bien été retiré de la liste",
                    type: "info"
                } as AddNotification)
                break
        }
    }

    contextMenu.value = null
}

const openFolder = async () => {
    const select = await pickFolder({
        directory: true,
        multiple: false,
        title: "Choisir un dossier de projet",
        defaultPath: homePath.value
    })

    if (select) await openProject(select as string)
}

const openProject = async (p: string) => {
    try {
        await invoke<void>('open_project', {path: p})
    } catch (e) {
        modalInitProject.value = {
            path: p,
            projectInfo: (e as [ProjectInfo, ProjectData])[0]
        }
    }
}

const showContextMenu = (e: Event, context: Project) => {
    const elBounding = (e.currentTarget as HTMLElement).getBoundingClientRect()
    contextMenu.value = {
        x: elBounding.left + elBounding.width / 2,
        y: elBounding.top + elBounding.height / 2,
        items: contextMenuItems,
        context: context
    }
}
</script>

<template>
    <main id="recent-projects" class="flex column align-center justify-center gap30">
        <BaseModal
            v-if="!!modalInitProject"
            title="Nouveau projet"
            @close="modalInitProject = null"
        >
            <div class="flex gap10">
                <div class="flex column gap15">
                    <SingleLineInput
                        v-model="modalInitProject.projectInfo.name"
                        :auto-focus="true"
                        label="Nom du projet"
                    />
                    <SingleLineInput
                        v-model="modalInitProject.projectInfo.description"
                        :auto-focus="true"
                        label="Description du projet"
                    />
                </div>

                <LineSeparator orientation="vertical"/>

                <div class="flex column gap15">
                    <SingleLineInput
                        v-model="modalInitProject.projectInfo.root_url"
                        :auto-focus="true"
                        class="large-input"
                        label="URL root de l'API"
                        placeholder="ex: http://localhost:3000/api"
                    />

                    <PathSelectInput
                        v-model="modalInitProject.path"
                        :is-folder="true"
                        :path-editable="true"
                        :show-path="true"
                        label="Dossier du projet"
                    />
                </div>
            </div>
        </BaseModal>

        <h1>Liste de vos APIs</h1>

        <div class="flex align-center gap10">
            <BaseButton :is-primary="true" @click="openFolder">
                Ouvrir un projet
            </BaseButton>
            <BaseButton>
                Nouveau projet
            </BaseButton>
        </div>

        <section class="grid-center">
            <CustomScrollbar v-if="sortedProjects.length > 0">
                <ul class="p-list flex column gap10">
                    <RecentProjectListItem
                        v-for="p in sortedProjects"
                        :key="p.path"
                        :home-path="homePath"
                        :project="p"
                        @openProject="openProject"
                        @showContextMenu="showContextMenu"
                    />
                </ul>
            </CustomScrollbar>
            <span v-else class="no-projects">
                Aucun projets récents
            </span>
        </section>

        <ContextMenu
            v-if="contextMenu"
            :items="contextMenu.items"
            :x="contextMenu.x"
            :y="contextMenu.y"
            @action="execAction"
            @close="contextMenu = null"
        />
    </main>
</template>

<style lang="scss" scoped>
#recent-projects {
    section {
        width: 50vw;
        min-width: 550px;
        height: 50vh;
        position: relative;
    }

    .no-projects {
        color: var(--color-font-light);
        font-size: 1.1em;
        font-weight: normal;
        text-align: center;
        width: 100%;
    }
}

:deep(.large-input) {
    min-width: 300px !important;
}
</style>